<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Load RFID Card | SmartBite</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="loadrfid.css">
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js"></script>
<script src="firebase_conn.js"></script>
<script type="module" src="add_load_rfid.js"></script>
<script type="module" src="student_list.js"></script>
<script type="module" src="role_access.js"></script>

<style>
@keyframes fadeInUp {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}
.animate-fadeInUp {
  animation: fadeInUp 0.6s ease forwards;
}

/* Processing Modal Styles */
.processing-spinner {
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top: 4px solid #ffffff;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Sidebar transition */
#sidebar {
  transition: all 0.3s ease;
}

.sidebar-collapsed {
  width: 70px !important;
}

.sidebar-collapsed .menu-text,
.sidebar-collapsed .logo-text {
  display: none;
}

.sidebar-collapsed .menu-item {
  justify-content: center;
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}

.sidebar-collapsed .toggle-btn {
  transform: rotate(180deg);
}

.main-expanded {
  margin-left: 70px;
}

.menu-item {
  transition: all 0.2s ease;
  border-radius: 0.5rem;
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
}

.menu-item:hover {
  background-color: rgba(59, 130, 246, 0.1);
  transform: translateX(2px);
}

.menu-item.active {
  background-color: rgba(59, 130, 246, 0.2);
  color: #3b82f6;
}

/* View Balance Button Styles */
.view-balance-btn {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
}

.view-balance-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
}

.view-balance-btn:active {
  transform: translateY(0);
}

.view-balance-btn:disabled {
  background: #9ca3af;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Balance Viewer Section */
.balance-viewer {
  background-color: #f8fafc;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  border: 1px solid #e2e8f0;
}

.balance-viewer h3 {
  font-size: 18px;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.balance-viewer-content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.balance-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.balance-info-item {
  display: flex;
  flex-direction: column;
}

.balance-info-label {
  font-size: 12px;
  color: #64748b;
  margin-bottom: 4px;
}

.balance-info-value {
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
}

/* Toggle between modes */
.mode-toggle {
  display: flex;
  background-color: #f1f5f9;
  border-radius: 10px;
  padding: 4px;
  margin-bottom: 16px;
}

.mode-btn {
  flex: 1;
  padding: 8px 12px;
  border-radius: 8px;
  text-align: center;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.mode-btn.active {
  background-color: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  color: #3b82f6;
}
</style>
</head>
<body class="bg-gray-100 flex min-h-screen font-inter">
<!-- Sidebar -->
<aside id="sidebar" class="bg-slate-900 w-64 min-h-screen flex flex-col shadow-lg relative">
  <!-- Toggle Button -->
  <div class="absolute -right-3 top-6 z-10">
    <button id="sidebarToggle" class="bg-slate-800 text-white p-2 rounded-full shadow-md hover:bg-slate-700 transition-colors toggle-btn">
      <i class="fas fa-chevron-left text-sm"></i>
    </button>
  </div>
  
  <!-- Logo Section -->
  <div class="bg-slate-800 p-4 flex items-center justify-center space-x-3">
    <i class="fas fa-wallet text-2xl text-blue-500"></i>
    <h1 class="text-xl font-bold text-white logo-text">SmartBite</h1>
  </div>

  <!-- Navigation Menu -->
  <nav class="flex-1 py-4 overflow-y-auto">
    <ul class="space-y-1 px-2">
      <li>
        <a href="index.html" class="menu-item text-gray-300 flex items-center" data-page="index.html">
          <i class="fas fa-credit-card w-6 text-center"></i>
          <span class="ml-3 menu-text">Register RFID</span>
        </a>
      </li>
      <li>
        <a href="load_rfid.html" class="menu-item text-gray-300 flex items-center active" data-page="load_rfid.html">
          <i class="fas fa-wallet w-6 text-center"></i>
          <span class="ml-3 menu-text">Load Card</span>
        </a>
      </li>
      <li>
        <a href="return_money.html" class="menu-item text-gray-300 flex items-center" data-page="return_money.html">
          <i class="fas fa-money-bill-wave w-6 text-center"></i>
          <span class="ml-3 menu-text">Withdraw Money</span>
        </a>
      </li>
      <li>
        <a href="products.html" class="menu-item text-gray-300 flex items-center" data-page="products.html">
          <i class="fas fa-box w-6 text-center"></i>
          <span class="ml-3 menu-text">Add Product</span>
        </a>
      </li>
      <li>
        <a href="https://websocket-testing-3tpu.onrender.com/buy_products.html" class="menu-item text-gray-300 flex items-center" data-page="buy_products.html">
          <i class="fas fa-shopping-cart w-6 text-center"></i>
          <span class="ml-3 menu-text">Buy Product</span>
        </a>
      </li>
      <li>
        <a href="sales.html" class="menu-item text-gray-300 flex items-center" data-page="sales.html">
          <i class="fas fa-chart-line w-6 text-center"></i>
          <span class="ml-3 menu-text">Sales</span>
        </a>
      </li>
      <li>
        <a href="logs.html" class="menu-item text-gray-300 flex items-center" data-page="logs.html">
          <i class="fas fa-clipboard-list w-6 text-center"></i>
          <span class="ml-3 menu-text">Logs</span>
        </a>
      </li>
      <li>
        <a href="add_role.html" class="menu-item text-gray-300 flex items-center" data-page="add_cashier.html">
          <i class="fas fa-user-plus w-6 text-center"></i>
          <span class="ml-3 menu-text">Role Management</span>
        </a>
      </li>
      <li>
        <a href="student_list.html" class="menu-item text-gray-300 flex items-center">
          <i class="fas fa-users w-6 text-center"></i>
          <span class="ml-3 menu-text">Student List</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- Logout button at the bottom -->
  <div class="p-4 border-t border-slate-700">
    <button id="logoutBtn" class="w-full flex items-center justify-center px-4 py-2 text-white bg-red-500 hover:bg-red-600 rounded-lg transition">
      <i class="fas fa-sign-out-alt mr-2"></i>
      <span class="menu-text">Logout</span>
    </button>
  </div>
</aside>

<!-- Logout Confirmation Modal -->
<div id="logoutConfirmationModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 px-4 backdrop-blur-sm">
  <div class="p-8 bg-white rounded-2xl shadow-2xl w-full max-w-md animate-slideUp">
    <div class="flex items-start justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Confirm Logout</h2>
      <button id="closeLogoutModalBtn" class="text-gray-400 hover:text-gray-600 transition">
        <i class="fas fa-times fa-lg"></i>
      </button>
    </div>
    
    <div class="space-y-6">
      <div class="flex items-center justify-center">
        <div class="bg-red-50 p-4 rounded-full">
          <i class="fas fa-sign-out-alt text-red-500 text-4xl"></i>
        </div>
      </div>
      
      <div class="text-center">
        <p class="text-lg text-gray-700 font-medium">Are you sure you want to logout?</p>
        <p class="text-sm text-gray-500 mt-2">You will need to log in again to access the system.</p>
      </div>
      
      <div class="flex justify-center gap-4 pt-2">
        <button id="cancelLogoutBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-xl font-semibold transition flex items-center gap-2">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button id="confirmLogoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition flex items-center gap-2 shadow-lg">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Load Card Section -->
<section id="mainContent" class="flex-1 flex flex-col items-center justify-center p-6 transition-all duration-300">
  <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md animate-fadeInUp">

    <!-- Title -->
    <div class="flex items-center justify-center mb-6 space-x-3 animate-fadeInUp">
      <i class="fas fa-wallet text-3xl text-blue-500"></i>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Load RFID Card</h1>
    </div>

    <!-- Mode Toggle -->
    <div class="mode-toggle animate-fadeInUp">
      <button id="viewBalanceModeBtn" class="mode-btn active">
        <i class="fas fa-eye mr-1"></i> View Balance
      </button>
      <button id="loadBalanceModeBtn" class="mode-btn">
        <i class="fas fa-plus mr-1"></i> Load Balance
      </button>
    </div>

    <!-- View Balance Section -->
    <div id="viewBalanceSection" class="balance-viewer animate-fadeInUp">
      <h3><i class="fas fa-info-circle text-blue-500"></i> Quick Balance Check</h3>
      <div class="balance-viewer-content">
        <button id="viewBalanceBtn" class="view-balance-btn">
          <i class="fas fa-credit-card"></i> Click to View Balance
        </button>
        <div class="balance-info">
          <div class="balance-info-item">
            <span class="balance-info-label">Current Balance</span>
            <span id="quickBalance" class="balance-info-value">₱0.00</span>
          </div>
          <div class="balance-info-item">
            <span class="balance-info-label">Card Holder</span>
            <span id="quickCardHolder" class="balance-info-value">-</span>
          </div>
          <div class="balance-info-item">
            <span class="balance-info-label">LRN</span>
            <span id="quickLRN" class="balance-info-value">-</span>
          </div>
          <div class="balance-info-item">
            <span class="balance-info-label">Status</span>
            <span id="quickStatus" class="balance-info-value">Ready</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Load Balance Section -->
    <div id="loadBalanceSection" class="hidden">
      <!-- Info Display -->
      <div class="bg-gray-50 rounded-xl p-4 mb-5 space-y-2 animate-fadeInUp">
        <p class="text-gray-700 flex items-center"><i class="fas fa-coins mr-2 text-yellow-500"></i> Balance: <span id="current_balance" class="font-semibold ml-1">0.00</span></p>
        <p class="text-gray-700 flex items-center"><i class="fas fa-user mr-2 text-blue-500"></i> Name: <span id="card_holder_name" class="font-semibold ml-1">-</span></p>
        <p class="text-gray-700 flex items-center"><i class="fas fa-id-card mr-2 text-green-500"></i> LRN: <span id="lrn" class="font-semibold ml-1">-</span></p>
      </div>

      <!-- Form -->
      <form id="loadCardForm" class="flex flex-col space-y-4 animate-fadeInUp">

        <!-- Card Number -->
        <div class="relative">
          <i class="fas fa-credit-card absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <input id="card_number_return" type="text" placeholder="Card Number"
                 class="p-4 pl-10 text-lg border border-gray-300 rounded-xl w-full focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-all duration-300 hover:shadow-md"
                 required pattern="\d*" title="Only numbers allowed" maxlength="10" minlength="10">
          <!-- Green checkmark validator -->
          <span id="cardValidIcon" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500 hidden">
            <i class="fas fa-check-circle text-lg"></i>
          </span>
        </div>

        <!-- Feedback message -->
        <p id="cardFeedback" class="mt-1 text-sm transition-colors duration-300"></p>

        <!-- Add Balance -->
        <div class="relative">
          <i class="fas fa-plus absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <input id="add_balance_input" type="text" placeholder="Add Balance" id="addedAmount"
                 class="p-4 pl-10 text-lg border border-gray-300 rounded-xl w-full focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-all duration-300 hover:shadow-md"
                 required>
        </div>

        <!-- Submit -->
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white p-4 text-lg rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-md">
          Add Balance
        </button>
      </form>
    </div>
  </div>
</section>

<!-- Processing Modal -->
<div id="processingModal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">
  <div class="modal-content bg-white rounded-2xl shadow-2xl p-10 w-11/12 max-w-md transform scale-90 opacity-0 transition-all duration-300">
    <div class="flex flex-col items-center">
      <div class="w-20 h-20 flex items-center justify-center rounded-full bg-blue-100 mb-6">
        <div class="processing-spinner"></div>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Processing Load Request</h2>
      <p class="text-gray-700 text-lg leading-relaxed text-center mb-2">Please wait while we process your balance load.</p>
      <p class="text-gray-600 text-center">This may take a few moments...</p>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">
  <div class="modal-content bg-white rounded-2xl shadow-2xl p-6 w-96 max-w-sm transform scale-90 opacity-0 transition-all duration-300">
    <div class="flex flex-col items-center">
      <!-- Check mark icon container - kept empty, will be populated by JavaScript -->
      <div id="successIconContainer" class="w-16 h-16 flex items-center justify-center rounded-full bg-green-100 mb-4">
        <!-- Icon will be inserted here by JavaScript -->
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Success!</h2>
      <p id="modalMessage" class="text-gray-700 text-center leading-relaxed">
        Your action was completed successfully.
      </p>
      <button id="closeModalBtn" class="bg-green-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-green-700 transition-all duration-300 transform hover:scale-105 mt-4">
        OK
      </button>
    </div>
  </div>
</div>

<!-- Balance Check Modal -->
<div id="balanceCheckModal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">
  <div class="modal-content bg-white rounded-2xl shadow-2xl p-6 w-96 max-w-sm transform scale-90 opacity-0 transition-all duration-300">
    <div class="flex flex-col items-center">
      <div class="w-16 h-16 flex items-center justify-center rounded-full bg-blue-100 mb-4">
        <i class="fas fa-credit-card text-blue-600 text-3xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Balance Information</h2>
      <div class="w-full bg-gray-50 p-4 rounded-lg mb-4">
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div class="text-gray-600">Card Holder:</div>
          <div id="modalCardHolder" class="font-medium">-</div>
          <div class="text-gray-600">LRN:</div>
          <div id="modalLRN" class="font-medium">-</div>
          <div class="text-gray-600">Card Number:</div>
          <div id="modalCardNumber" class="font-medium">-</div>
          <div class="text-gray-600">Current Balance:</div>
          <div id="modalBalance" class="font-medium text-green-600">₱0.00</div>
        </div>
      </div>
      <button id="closeBalanceModalBtn" class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
        OK
      </button>
    </div>
  </div>
</div>

<script>
  // Sidebar toggle functionality
  document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleBtn = document.getElementById('sidebarToggle');
    const menuItems = document.querySelectorAll('.menu-item');
    
    // Set active menu item based on current page
    const currentPage = window.location.pathname.split('/').pop();
    menuItems.forEach(item => {
      if (item.getAttribute('data-page') === currentPage) {
        item.classList.add('active');
      }
    });
    
    // Toggle sidebar
    toggleBtn.addEventListener('click', function() {
      sidebar.classList.toggle('sidebar-collapsed');
      mainContent.classList.toggle('main-expanded');
      
      // Change toggle button icon
      const icon = toggleBtn.querySelector('i');
      if (sidebar.classList.contains('sidebar-collapsed')) {
        icon.classList.remove('fa-chevron-left');
        icon.classList.add('fa-chevron-right');
      } else {
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-left');
      }
    });
    
    // Initialize logout modal
    initializeLogoutModal();

    // Mode toggle functionality
    const viewBalanceModeBtn = document.getElementById('viewBalanceModeBtn');
    const loadBalanceModeBtn = document.getElementById('loadBalanceModeBtn');
    const viewBalanceSection = document.getElementById('viewBalanceSection');
    const loadBalanceSection = document.getElementById('loadBalanceSection');

    viewBalanceModeBtn.addEventListener('click', function() {
      viewBalanceModeBtn.classList.add('active');
      loadBalanceModeBtn.classList.remove('active');
      viewBalanceSection.classList.remove('hidden');
      loadBalanceSection.classList.add('hidden');
    });

    loadBalanceModeBtn.addEventListener('click', function() {
      loadBalanceModeBtn.classList.add('active');
      viewBalanceModeBtn.classList.remove('active');
      loadBalanceSection.classList.remove('hidden');
      viewBalanceSection.classList.add('hidden');
    });
  });

  // Logout functionality with modal
  function initializeLogoutModal() {
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutModal = document.getElementById('logoutConfirmationModal');
    const closeLogoutModalBtn = document.getElementById('closeLogoutModalBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');

    if (!logoutBtn || !logoutModal) {
      console.log('Logout elements not found');
      return;
    }

    // Remove any existing event listeners
    const newLogoutBtn = logoutBtn.cloneNode(true);
    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

    // Get fresh references
    const refreshedLogoutBtn = document.getElementById('logoutBtn');

    // Show logout modal when logout button is clicked
    refreshedLogoutBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Logout button clicked - showing modal');
      logoutModal.classList.remove('hidden');
      logoutModal.classList.add('flex');
      document.body.classList.add('overflow-hidden');
    });

    // Close modal when close button is clicked
    closeLogoutModalBtn.addEventListener('click', function() {
      console.log('Close logout modal');
      logoutModal.classList.add('hidden');
      logoutModal.classList.remove('flex');
      document.body.classList.remove('overflow-hidden');
    });

    // Close modal when cancel button is clicked
    cancelLogoutBtn.addEventListener('click', function() {
      console.log('Cancel logout');
      logoutModal.classList.add('hidden');
      logoutModal.classList.remove('flex');
      document.body.classList.remove('overflow-hidden');
    });

    // Perform logout when confirm button is clicked
    confirmLogoutBtn.addEventListener('click', function() {
      console.log('Confirming logout');
      
      // Show processing state
      confirmLogoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out...';
      confirmLogoutBtn.disabled = true;

      // Clear local storage
      localStorage.removeItem('cashierUser');
      localStorage.removeItem('userRole');
      localStorage.removeItem('userName');
      sessionStorage.clear();

      // Redirect to login page
      window.location.href = '/SMARTBITE-ADMIN/login.html';
    });

    // Close modal when clicking outside
    logoutModal.addEventListener('click', function(e) {
      if (e.target === logoutModal) {
        console.log('Clicked outside modal - closing');
        logoutModal.classList.add('hidden');
        logoutModal.classList.remove('flex');
        document.body.classList.remove('overflow-hidden');
      }
    });
  }

  // Modal control functions
  function showProcessingModal() {
    const modal = document.getElementById('processingModal');
    const modalContent = modal.querySelector('.modal-content');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
      modalContent.style.transform = 'scale(1)';
      modalContent.style.opacity = '1';
    }, 10);
  }

  function hideProcessingModal() {
    const modal = document.getElementById('processingModal');
    const modalContent = modal.querySelector('.modal-content');
    
    modalContent.style.transform = 'scale(0.9)';
    modalContent.style.opacity = '0';
    
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
  }

  function showSuccessModal(message) {
    const modal = document.getElementById('successModal');
    const modalContent = modal.querySelector('.modal-content');
    const modalMessage = document.getElementById('modalMessage');
    
    modalMessage.innerHTML = message;
    modal.classList.remove('hidden');
    
    setTimeout(() => {
      modalContent.style.transform = 'scale(1)';
      modalContent.style.opacity = '1';
    }, 10);
    
    // Close modal when OK button is clicked
    document.getElementById('closeModalBtn').onclick = function() {
      modalContent.style.transform = 'scale(0.9)';
      modalContent.style.opacity = '0';
      
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    };
  }

  // Balance Check Modal Functions
  function showBalanceCheckModal(cardData) {
    const modal = document.getElementById('balanceCheckModal');
    const modalContent = modal.querySelector('.modal-content');
    
    // Populate modal with card data
    document.getElementById('modalCardHolder').textContent = cardData.name || '-';
    document.getElementById('modalLRN').textContent = cardData.lrn || '-';
    document.getElementById('modalCardNumber').textContent = cardData.cardNumber || '-';
    document.getElementById('modalBalance').textContent = `₱${parseFloat(cardData.balance || 0).toFixed(2)}`;
    
    modal.classList.remove('hidden');
    
    setTimeout(() => {
      modalContent.style.transform = 'scale(1)';
      modalContent.style.opacity = '1';
    }, 10);
    
    // Close modal when OK button is clicked
    document.getElementById('closeBalanceModalBtn').onclick = function() {
      modalContent.style.transform = 'scale(0.9)';
      modalContent.style.opacity = '0';
      
      setTimeout(() => {
        modal.classList.add('hidden');
        // Reset view balance button
        resetViewBalanceButton();
      }, 300);
    };
  }

  // View Balance Functionality
  document.addEventListener('DOMContentLoaded', function() {
    const viewBalanceBtn = document.getElementById('viewBalanceBtn');
    const quickBalance = document.getElementById('quickBalance');
    const quickCardHolder = document.getElementById('quickCardHolder');
    const quickLRN = document.getElementById('quickLRN');
    const quickStatus = document.getElementById('quickStatus');
    
    let isCheckingBalance = false;
    let cardInputActive = false;
    
    // Create a hidden card input for balance checking
    const hiddenCardInput = document.createElement('input');
    hiddenCardInput.type = 'text';
    hiddenCardInput.id = 'hiddenCardInput';
    hiddenCardInput.style.position = 'absolute';
    hiddenCardInput.style.opacity = '0';
    hiddenCardInput.style.pointerEvents = 'none';
    hiddenCardInput.style.height = '0';
    hiddenCardInput.style.width = '0';
    document.body.appendChild(hiddenCardInput);
    
    // Reset view balance button state
    function resetViewBalanceButton() {
      viewBalanceBtn.disabled = false;
      viewBalanceBtn.innerHTML = '<i class="fas fa-credit-card"></i> Click to View Balance';
      quickStatus.textContent = 'Ready';
      quickStatus.className = 'balance-info-value';
      cardInputActive = false;
      hiddenCardInput.value = '';
      hiddenCardInput.blur();
    }
    
    // Start balance check process
    viewBalanceBtn.addEventListener('click', function() {
      if (isCheckingBalance) return;
      
      isCheckingBalance = true;
      viewBalanceBtn.disabled = true;
      viewBalanceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ready for Card Tap';
      quickStatus.textContent = 'Waiting for card...';
      quickStatus.className = 'balance-info-value text-yellow-600';
      
      // Reset display
      quickBalance.textContent = '₱0.00';
      quickCardHolder.textContent = '-';
      quickLRN.textContent = '-';
      
      // Focus on hidden input to capture card data
      cardInputActive = true;
      hiddenCardInput.value = '';
      hiddenCardInput.focus();
      
      // Set timeout to reset if no card is tapped
      setTimeout(() => {
        if (cardInputActive) {
          resetViewBalanceButton();
          isCheckingBalance = false;
          quickStatus.textContent = 'Timeout - Try again';
          quickStatus.className = 'balance-info-value text-red-600';
        }
      }, 10000); // 10 second timeout
    });
    
    // Handle card input in hidden field
    hiddenCardInput.addEventListener('input', function() {
      if (!cardInputActive) return;
      
      // Remove any non-digit characters and limit to 10 digits
      this.value = this.value.replace(/\D/g, '').slice(0, 10);
      
      // Check if we have a complete card number
      if (this.value.length === 10) {
        cardInputActive = false;
        viewBalanceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking Balance...';
        quickStatus.textContent = 'Checking balance...';
        
        // Fetch card information
        fetchCardBalance(this.value);
      }
    });
    
    // Fetch card balance information
    async function fetchCardBalance(cardNumber) {
      try {
        const userData = await window.fetchCurrentBalance(cardNumber);
        
        if (userData && !userData.disabled) {
          // Update quick view display
          const balance = parseFloat(userData.balance || 0).toFixed(2);
          const name = `${userData.first_name || userData.student_fname || ''} ${userData.middle_name || userData.student_mname || ''} ${userData.last_name || userData.student_lname || ''}`.trim();
          const lrn = userData.lrn_number || '-';
          
          quickBalance.textContent = `₱${balance}`;
          quickCardHolder.textContent = name || '-';
          quickLRN.textContent = lrn;
          quickStatus.textContent = 'Balance retrieved';
          quickStatus.className = 'balance-info-value text-green-600';
          
          // Show detailed modal
          showBalanceCheckModal({
            name: name,
            lrn: lrn,
            cardNumber: cardNumber,
            balance: balance
          });
        } else {
          // Card not found or disabled
          quickBalance.textContent = '₱0.00';
          quickCardHolder.textContent = '-';
          quickLRN.textContent = '-';
          quickStatus.textContent = userData ? 'Account disabled' : 'Card not found';
          quickStatus.className = 'balance-info-value text-red-600';
          
          // Reset button after a delay
          setTimeout(() => {
            resetViewBalanceButton();
          }, 2000);
        }
      } catch (error) {
        console.error('Error fetching card balance:', error);
        quickStatus.textContent = 'Error fetching balance';
        quickStatus.className = 'balance-info-value text-red-600';
        
        // Reset button after a delay
        setTimeout(() => {
          resetViewBalanceButton();
        }, 2000);
      } finally {
        isCheckingBalance = false;
      }
    }
    
    // Allow manual entry as fallback
    hiddenCardInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        resetViewBalanceButton();
        isCheckingBalance = false;
      }
    });
  });
</script>

</body>
</html>
